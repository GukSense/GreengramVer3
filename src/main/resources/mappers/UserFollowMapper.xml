<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.green.greengram.userfollow.UserFollowMapper">
    <insert id="insUserFollow">
        INSERT INTO user_follow
        SET         from_user_id = #{fromUserId},
                    to_user_id = #{toUserId}
    </insert>

    <delete id="deleteUserFollow">
        DELETE FROM user_follow WHERE from_user_id = #{fromUserId} AND to_user_id = #{toUserId}
    </delete>

    <select id="">
        SELECT A.nm,
                   A.pic,
                   A.created_at
                  ,B.feedCnt, B.favCnt
                  ,C.following, C.follower, C.followState
        FROM       user A
        INNER JOIN (
                   SELECT A.writer_id
                 , COUNT(distinct A.feed_id) AS feedCnt
                 , COUNT(B.user_id) AS favCnt
                   FROM feed A
        LEFT JOIN  feed_favorite B
        ON         A.feed_id = B.feed_id
                   WHERE A.writer_id = #{profileUserId}
        ) B
        INNER JOIN (
                   SELECT SUM(IF(from_user_id = #{profileUserId}, 1, 0)) AS following
                 , SUM(IF(to_user_id = #{profileUserId}, 1, 0)) AS follower
                 , IFNULL(
                    SUM(
                        IF(from_user_id = #{signedUserId} AND to_user_id = #{profileUserId}, 1, 0)
                        +
                        IF(from_user_id = #{profileUserId} AND to_user_id = #{signedUserId}, 2, 0)
                       )
                 , 0) AS followState
                   FROM user_follow
        ) C
        WHERE A.user_id = #{profileUserId}
    </select>
</mapper>